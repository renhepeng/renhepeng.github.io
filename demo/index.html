<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title> Simple Dapp </title>

  <link rel="stylesheet" type="text/css" href="main.css">
  <!-- 本地导入web3.js -->
  <script src="web3.min.js"></script>
  <script src="jquery.js"></script>

  <!-- unpkg导入web3.js -->
  <!-- <script type="text/javascript" src="https://unpkg.com/web3@0.20.5/dist/web3.min.js"></script> -->

  <!-- cdn导入web3.js -->
  <!-- <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script> -->


</head>

<body>

  <div class="container">

    <h1> Simple Dapp </h1>

    <h2 id="info"> </h2>

    <label>姓名：</label>
    <input type="text" id="name">

    <label>年龄：</label>
    <input type="text" id="age">

    <button type="button" id="button"> 更新 </button>

  </div>

</body>
 
<script>
  /*
    MetaMask只支持站点方式调用，不支持本地文件方式调用
    MetaMask默认为隐私模式，需要调用的站点，必须先请求MetaMask的授权
    MetaMask授权成功以后，会向当前站点提供Provider（web3对象）
  */
  // 请求MetaMask的授权当前站点（只需要授权一次）
  window.addEventListener('load', async () => {
    // Modern dapp browsers...
    if (window.ethereum) {
      window.web3 = new Web3(ethereum);
      try {
        // Request account access if needed
        await ethereum.enable();

        // Acccounts now exposed
        web3.eth.sendTransaction({/* ... */ });

      } catch (e) {
        // User denied account access...
      }

      // Legacy dapp browsers...
    } else if (window.web3) {
      window.web3 = new Web3(web3.currentProvider);
      // Acccounts always exposed
      web3.eth.sendTransaction({/* ... */ });

      // Non-dapp browsers...
    } else {
      console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
    }
  });

  // 判断当前环境是否存在web3对象
  if (typeof web3 !== 'undefined') {
    // web服务器站点打开dapp会自动关联到 MetaMask
    // MetaMask会将包含Provider的js注入到页面
    web3 = new Web3(web3.currentProvider);
  } else {
    // 自定义Provider
    // file本地文件方式打开dapp会关联到自定义Provider(Ganache等)
    web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
  }
  console.log(web3);
  console.log(web3.eth);

  web3.eth.defaultAccount = web3.eth.accounts[0];

  var ABIString = [
    {
      "constant": false,
      "inputs": [
        {
          "name": "_name",
          "type": "string"
        },
        {
          "name": "_age",
          "type": "uint256"
        }
      ],
      "name": "setInfo",
      "outputs": [],
      "payable": false,
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "name": "name",
          "type": "string"
        },
        {
          "indexed": false,
          "name": "age",
          "type": "uint256"
        }
      ],
      "name": "Instructor",
      "type": "event"
    },
    {
      "constant": true,
      "inputs": [],
      "name": "getInfo",
      "outputs": [
        {
          "name": "",
          "type": "string"
        },
        {
          "name": "",
          "type": "uint256"
        }
      ],
      "payable": false,
      "stateMutability": "view",
      "type": "function"
    }
  ];

  // 使用合约ABI创建合约对象
  var infoContract = web3.eth.contract(ABIString);
  // 使用合约地址加载合约并实例化合约对象
  var info = infoContract.at('0xec19253050EE3aF881f87FE460260a8f18b718B7');

  // 调用合约方法 - 读取
  info.getInfo(
    function (error, result) {
      if (!error) {
        var name = result[0];
        var age = result[1];
        $("#info").html('姓名：' + name + ' 年龄：' + age)
        console.log(result);
      }
    }
  );

  // 调用合约方法 - 写入
  $("#button").click(function () {
    // 最后一个参数是回调函数，error first风格
    info.setInfo($("#name").val(), $("#age").val(),
      function (error, result) {
        if (!error) {
          alert('更新成功');
        } else {
          alert('更新失败');
        }
        console.log(result);
      }
    );
  });

</script>

</html>